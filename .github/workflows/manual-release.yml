name: Trigger Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: >
          Version bump type (patch | minor | major) or an explicit version
          number (e.g. 2.3.0). Do not include a leading 'v'.
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: >
          Required when bump is set to "custom". Enter the exact version
          number to release (e.g. 1.4.2). Ignored for patch/minor/major.
        required: false
        default: ''
      overwrite_tag:
        description: >
          Delete and recreate the git tag if it already exists.
          Only needed when re-releasing the same version number.
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Bump version & push tag
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        run: |
          BUMP="${{ github.event.inputs.bump }}"
          CUSTOM="${{ github.event.inputs.custom_version }}"
          if [ "$BUMP" = "custom" ] && [ -z "$CUSTOM" ]; then
            echo "::error::bump is set to 'custom' but custom_version is empty."
            exit 1
          fi
          if [ "$BUMP" = "custom" ]; then
            # Basic semver sanity check
            if ! echo "$CUSTOM" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "::error::custom_version '$CUSTOM' is not a valid semver (expected X.Y.Z)."
              exit 1
            fi
          fi

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Set git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Resolve version argument
        id: version
        run: |
          BUMP="${{ github.event.inputs.bump }}"
          if [ "$BUMP" = "custom" ]; then
            echo "arg=${{ github.event.inputs.custom_version }}" >> "$GITHUB_OUTPUT"
          else
            echo "arg=$BUMP" >> "$GITHUB_OUTPUT"
          fi

      - name: Run release script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OVERWRITE="${{ github.event.inputs.overwrite_tag }}"
          EXTRA_FLAGS=""
          if [ "$OVERWRITE" = "true" ]; then
            EXTRA_FLAGS="--force-tag"
          fi
          node scripts/release.js "${{ steps.version.outputs.arg }}" $EXTRA_FLAGS

      - name: Write job summary
        run: |
          BUMP="${{ github.event.inputs.bump }}"
          VERSION="${{ steps.version.outputs.arg }}"
          echo "## ðŸš€ Release triggered" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ----- | ----- |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Bump type | \`$BUMP\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Version arg | \`$VERSION\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Triggered by | @${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "The tag push will start the **Release** workflow automatically." >> "$GITHUB_STEP_SUMMARY"
